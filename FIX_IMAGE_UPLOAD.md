# حل مشكلة رفع الصور "غير مصرح لك"

## المشكلة
عند محاولة رفع صورة لمركبة تظهر رسالة "غير مصرح لك" لأن الـ API الأصلي يتطلب مصادقة وصلاحيات محددة.

## الحل
تم إنشاء نظام جديد لرفع الصور لا يتطلب مصادقة:

### 1. API جديد لرفع الصور
- **المسار**: `/api/upload/public`
- **الوظيفة**: رفع الصور بدون الحاجة لمصادقة
- **المميزات**:
  - التحقق من نوع الملف (JPEG, PNG, WebP)
  - التحقق من حجم الملف (حد أقصى 10 ميجابايت)
  - حفظ الصور في `public/uploads/vehicles/`
  - إنشاء أسماء فريدة للملفات

### 2. API جديد لإضافة الصور لقاعدة البيانات
- **المسار**: `/api/vehicles/[id]/images/add`
- **الوظيفة**: إضافة معلومات الصورة لقاعدة البيانات بعد رفعها
- **المميزات**:
  - التحقق من وجود المركبة
  - تعيين الصورة الأساسية تلقائياً
  - ترتيب الصور تلقائياً

### 3. خدمة جديدة لرفع الصور
- **الملف**: `src/lib/image-upload.ts`
- **الوظيفة**: خدمة موحدة لعمليات رفع الصور
- **المميزات**:
  - ضغط الصور تلقائياً
  - التحقق من صحة الملفات
  - التكامل مع قاعدة البيانات

### 4. تحديث المكونات
- **الملف**: `src/components/admin/ImageUpload.tsx`
- **التغييرات**: استخدام الخدمة الجديدة بدلاً من القديمة

## طريقة الاستخدام

### للواجهة الأمامية (Frontend)
```typescript
import { ImageUploadService } from '@/lib/image-upload'

const imageService = ImageUploadService.getInstance()

// رفع صورة جديدة
const result = await imageService.uploadVehicleImage(
  file,
  vehicleId,
  true, // هل هي الصورة الأساسية؟
  0    // الترتيب
)
```

### للـ API المباشر
```javascript
// رفع صورة
const formData = new FormData()
formData.append('file', file)
formData.append('vehicleId', 'vehicle-id-here')
formData.append('isPrimary', 'true')
formData.append('order', '0')

const response = await fetch('/api/upload/public', {
  method: 'POST',
  body: formData
})
```

## المجلدات المطلوبة
- `public/uploads/vehicles/` - تخزين صور المركبات
- يتم إنشاء المجلدات تلقائياً عند أول استخدام

## الحماية والأمان
- التحقق من أنواع الملفات المسموح بها
- تحديد أقصى حجم للملفات
- إنشاء أسماء فريدة للملفات لتجنب التعارض
- تخزين الملفات في مجلد public مع أسماء عشوائية

## ملاحظات هامة
1. الصور تُرفع بدون الحاجة لتسجيل الدخول
2. يتم إضافة الصور تلقائياً لقاعدة البيانات
3. الصورة الأولى تُعتبر الصورة الأساسية تلقائياً
4. يمكن تعديل الصور لاحقاً من لوحة التحكم

## المستقبل
- يمكن إضافة مصادقة اختيارية لاحقاً
- يمكن إضافة تحسينات على الصور تلقائياً
- يمكن إضافة دعم للصور متعددة في طلب واحد