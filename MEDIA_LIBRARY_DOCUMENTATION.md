# نظام إدارة الوسائط - مكتبة الوسائط المتقدمة

## نظرة عامة

نظام إدارة الوسائط هو نظام متكامل لإدارة الصور والملفات في الموقع، يوفر واجهة سهلة الاستخدام لرفع وتنظيم وتعديل وحذف الملفات مع دعم كامل للبحث والتصفية والتصنيف.

## المميزات الرئيسية

### 1. إدارة الملفات
- **رفع الملفات**: دعم رفع ملفات متعددة في نفس الوقت
- **الصور**: دعم الصور بتنسيقات JPEG, PNG, WebP, GIF
- **المستندات**: دعم PDF, DOC, DOCX
- **الحجم الأقصى**: 10 ميجابايت للملف الواحد
- **الضغط التلقائي**: ضغط الصور تلقائياً عند الرفع

### 2. التنظيم والتصنيف
- **الفئات**: تنظيم الملفات في فئات مختلفة (المركبات، الشركة، الخدمات، المدونة، معرض الصور، اللافتات)
- **الوسوم**: إضافة وسوم متعددة للملفات للبحث السهل
- **المجلدات**: عرض الملفات حسب الفئات كمجلدات
- **البحث**: بحث متقدم في أسماء الملفات والعناوين والوسوم

### 3. الواجهة المستخدمة
- **عرض الشبكة**: عرض الملفات كصور مصغرة
- **عرض القائمة**: عرض الملفات كقائمة مفصلة
- **التحديد المتعدد**: تحديد عدة ملفات للعمليات الجماعية
- **السحب والإفلات**: دعم رفع الملفات بالسحب والإفلات

### 4. التعديل والإدارة
- **تعديل البيانات**: تعديل العنوان والنص البديل والوصف والفئة والوسوم
- **الحذف**: حذف الملفات الفردية أو الجماعية
- **نسخ الرابط**: نسخ رابط الملف بسهولة
- **معاينة**: معاينة الملفات في نافذة جديدة

## الهيكل التقني

### قاعدة البيانات

```sql
model Media {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  path         String
  url          String
  thumbnailUrl String?
  mimeType     String
  size         Int
  width        Int?
  height       Int?
  altText      String?
  title        String?
  description  String?
  tags         String   // JSON array
  category     String   @default("other")
  entityId     String?
  isPublic     Boolean  @default(true)
  isFeatured   Boolean  @default(false)
  order        Int      @default(0)
  metadata     String?  // JSON object
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    String
}
```

### واجهات البرمجة (API)

#### 1. GET /api/media-simple
الحصول على قائمة الملفات مع دعم التصفية والبحث

**المعلمات:**
- `limit`: عدد الملفات في الصفحة (افتراضي: 50)
- `offset`: رقم البداية (افتراضي: 0)
- `category`: فلترة حسب الفئة
- `search`: بحث في الملفات
- `sortBy`: حقل الترتيب (افتراضي: createdAt)
- `sortOrder`: اتجاه الترتيب (افتراضي: desc)

**الاستجابة:**
```json
{
  "success": true,
  "data": {
    "files": [...],
    "total": 47,
    "hasMore": false
  }
}
```

#### 2. POST /api/media-simple
رفع ملف جديد

**البيانات:**
- `file`: الملف المرفوع
- `options`: خيارات الرفع (JSON)
  - `category`: الفئة
  - `generateThumbnails`: إنشاء صور مصغرة
  - `optimizeFormats`: تنسيقات التحسين

#### 3. PUT /api/media-simple?id={id}
تحديث بيانات ملف

**البيانات:**
```json
{
  "title": "العنوان",
  "altText": "النص البديل",
  "description": "الوصف",
  "tags": ["وسم1", "وسم2"],
  "category": "vehicles"
}
```

#### 4. DELETE /api/media-simple?id={id}
حذف ملف

## الأذونات والأدوار

### الأدوار المسموح لها:
- **ADMIN**: صلاحيات كاملة
- **SUPER_ADMIN**: صلاحيات كاملة
- **BRANCH_MANAGER**: رفع، تعديل، حذف ملفات الفرع
- **STAFF**: رفع وتعديل الملفات

### الصلاحيات:
- **المشاهدة**: جميع الأدوار يمكنها مشاهدة الملفات
- **الرفع**: ADMIN, SUPER_ADMIN, BRANCH_MANAGER
- **التعديل**: ADMIN, SUPER_ADMIN, BRANCH_MANAGER
- **الحذف**: ADMIN, SUPER_ADMIN فقط

## الفئات المتاحة

1. **vehicles**: المركبات والسيارات
2. **company**: صور الشركة والفروع
3. **services**: الخدمات والصيانة
4. **blog**: المدونة والمقالات
5. **gallery**: معرض الصور
6. **banner**: اللافتات والإعلانات
7. **other**: أخرى (افتراضي)

## المجلدات والتخزين

### هيكل التخزين:
```
public/
├── uploads/
│   ├── media/           # الملفات المرفوعة حديثاً
│   ├── vehicles/        # صور المركبات
│   ├── banners/         # اللافتات
│   ├── thumbnails/      # الصور المصغرة
│   └── ...
```

### تسمية الملفات:
- يتم إنشاء اسم فريد لكل ملف
- التنسيق: `{timestamp}_{random}.{extension}`
- مثال: `1704123456_abc123.jpg`

## التحسين والأداء

### تحسين الصور:
- ضغط تلقائي للصور عند الرفع
- إنشاء صور مصغرة تلقائياً
- دعم تنسيق WebP للأداء الأفضل

### التخزين المؤقت:
- التخزين المؤقت للبيانات في الذاكرة
- تحسين استعلامات قاعدة البيانات
- استخدام الفهارس للبحث السريع

## الأمان

### التحقق من الملفات:
- التحقق من نوع الملف
- التحقق من حجم الملف
- فحص محتوى الملف

### الحماية:
- التحقق من صلاحيات المستخدم
- منع رفع الملفات الضارة
- حماية من الوصول غير المصرح به

## واجهة المستخدم

### المكونات الرئيسية:
1. **شريط الأدوات**: الأزرار الرئيسية (رفع، حذف، تحديد الكل)
2. **شريط البحث**: البحث والتصفية والترتيب
3. **عرض الملفات**: الشبكة أو القائمة
4. **نوافذ الحوار**: رفع الملفات، تعديل البيانات

### التفاعلات:
- النقر على الملف: معاينة
- النقر المزدوج: تعديل
- التحديد بالعقد: تحديد متعدد
- السحب والإفلات: رفع الملفات

## النقل والترحيل

### نقل الملفات الموجودة:
```bash
# تشغيل سكربت إضافة الملفات الموجودة
npx tsx scripts/add-existing-media.ts
```

### إضافة بيانات تجريبية:
```bash
# إضافة عينات من الوسائط
npx tsx scripts/add-sample-media.ts
```

## الصيانة

### تنظيف الملفات:
- حذف الملفات غير المستخدمة
- ضغط الصور القديمة
- أرشفة الملفات القديمة

### النسخ الاحتياطي:
- نسخ احتياطي لقاعدة البيانات
- نسخ احتياطي للملفات
- التحقق من سلامة الملفات

## استكشاف الأخطاء

### مشاكل شائعة:

1. **الملف لا يظهر:**
   - تحقق من صلاحيات المستخدم
   - تأكد من رفع الملف بنجاح
   - تحقق من فلتر البحث

2. **فشل في الرفع:**
   - تحقق من حجم الملف
   - تأكد من نوع الملف المدعوم
   - تحقق من الاتصال بالإنترنت

3. **الصورة لا تعرض:**
   - تحقق من رابط الصورة
   - تأكد من وجود الملف في الخادم
   - تحقق من صلاحيات الملف

## التحديثات المستقبلية

### المميزات المخطط لها:
1. **دعم الفيديو**: رفع وإدارة الفيديوهات
2. **التحرير المتقدم**: تحرير الصور داخل النظام
3. **التكامل مع السحابة**: التخزين السحابي
4. **النسخ الاحتياطي التلقائي**: نسخ احتياطي تلقائي للملفات
5. **التحليلات**: إحصائيات استخدام الملفات

## الدعم الفني

### التواصل:
- البريد الإلكتروني: support@example.com
- الوثائق: https://docs.example.com/media
- الإبلاغ عن المشاكل: https://github.com/example/issues

---

**ملاحظة:** هذا النظام جزء من نظام إدارة المحتوى المتكامل ويتكامل مع باقي أجزاء النظام لإدارة المحتوى بشكل شامل.